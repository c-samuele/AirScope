# AirScope

**Web service** for air quality monitoring that allows:

• CSV file upload
• Adding a new measurement
• Editing a measurement
• Deleting a measurement
• Deleting a file
• Displaying average values
• Displaying uploaded files
• Tabular visualization of measurements
• Infographic visualization of measurements

The system is based on measurements coming from open data and is designed for the Marche region. The ARPA data of the city of Urbino will be used as reference; nevertheless the system can be used for any city provided that uploaded files follow the example model standard.

## Technologies used

### Frontend
• HTML5, CSS3 and JavaScript  
Used on the client side respectively for page and content creation, custom styling, dynamic content management and feedback.

• Bootstrap 5  
Chosen and used for page creation using the column structure and components such as Toast, Modal and Icons.

• Chart.js  
Library chosen for infographic representation of open data.

• jQuery  
JS library adopted for backward compatibility between browsers, AJAX calls and to simplify syntax where possible ("Write less, do more").

• LocalStorage  
Native web storage technology used to store data as key-value pairs, used to store the name of the file currently in use.

### Backend
• Node.js  
Chosen as JavaScript runtime on the server side and for package management with npm.

• Express.js  
Framework used to create the web server, define routes and handle HTTP calls.

• Multer  
Open source middleware used for file upload from forms.

• csv-parse  
Library used to parse uploaded CSV files.

• fs  
Node module used to perform file system operations.

• path  
Node module used to work with paths so as to make them OS-independent.

• JSON files  
JavaScript Object Notation is the chosen data structure to persistently save measurements and the list of uploaded files.

## Process model
An Agile approach combined with the Incremental Model was adopted for development.
Constant refactoring and testing in parallel with implementation characterized the entire project.

• In the early phases of the project a minimum viable version was achieved.
• At the end of each increment a paper Backlog containing changes and bugs to fix for the next phase was produced.
• Development was tracked with Git adopting the versioning policy (Major.Minor.Patch).

## Architecture of the service

### Architecture
The adopted service architecture is Client-Server.

### Communication model
The communication model is Request-Response via the HTTP protocol.
The web server responds to Client requests following the RESTful model using CRUD verbs.

### Implementation choices

#### Directory structure
/ (root)
- node_modules/
- public/
  - assets/
  - img/
  - svg/
  - script/
  - style.css
  - service/
    - dashboard.html
    - analytics.html
    - request.html
  - index.html
  - service.html
- upload/
- utils/
- server.js

#### Client (Public)
On the client side, the public content is located inside the `public` directory except for libraries added through npm (bootstrap, chart.js, jQuery) which are exposed by the server.
At the root of `public` there is `index.html` which acts as the landing page to access the service and `service.html` which contains the base GUI including: menu, main content section, Modal area and the Toast area for feedback.

• A custom stylesheet was used to compensate for Bootstrap rigidity and to define general styles for components (for example the `general-container` used for each content shown in the main section).

#### Assets
Contains all static resources for the service pages, custom styles, and scripts to populate, manipulate and listen to HTML and related events.

• Validation when adding a single measurement occurs directly via the HTML form with appropriate attributes.
• It is possible to omit pollutant values during insertion/editing of open data since in some situations sensors can be turned off or not have all data available.

#### Script
The Script directory inside Assets contains the main file `main.js`, which handles page content loading, calling the functions that populate tables, charts, Toasts and average value calculations.

• A `debug` variable was used to enable/disable logs during implementation.
• The filename currently in use is saved in LocalStorage and this variable is passed in two different ways to all functions that make requests to the server, so as to specify not only the action but also which resource to operate on.
• Client-side API calls are handled asynchronously via AJAX with jQuery so as not to block or reload the user interface.
• On each file modification, content is regenerated by calling the appropriate functions after initializing tables and charts to avoid conflicts.
• Each user action on the data has visual feedback via Bootstrap Toasts with custom coloring.
• Potentially dangerous operations require confirmation before being executed.

#### Service
This directory contains the three sections of the service, i.e. the HTML content to be injected into the DOM depending on the user's choice.

## Server
The server is at the root level and is the file that defines the routes to use the service and therefore the CRUD methods, as well as the actions that the user can take on persistent data. This is the core of the business logic of the service and uses the directories listed above.

### Utils
Contains functions for reading, writing and modifying files on the server side.

• During the parsing of each uploaded file, date and time formats are checked and normalized using server-side utility functions.

### Upload
This directory will store uploaded CSV files and converted JSON files via multer and will also contain the main `files.json` to keep track of all files currently present in that directory.

• A management strategy was adopted to prevent inserting duplicate files.
• After parsing, the source CSVs are deleted because all subsequent manipulation occurs exclusively on JSON files converted into JavaScript objects.
• Attribution of the data provider agency is left to the user's responsibility at upload time via the dedicated form to satisfy the obligation imposed by the license (CC BY 4.0).

## Data

### Open Data
The data used for testing the web service come from:
• ARPA Marche: https://www.arpa.marche.it/

They were cut and edited for demonstration purposes such as testing and validation.

### License
• Creative Commons - Attribution 4.0 International (CC BY 4.0):
https://creativecommons.org/licenses/by/4.0/

Allows sharing, copying, redistribution, modification and use in any medium or format for any purpose including commercial, with the obligation to give appropriate credit, indicate the license and specify if changes were made.

## API Documentation
The web service APIs are designed following the Request/Response model over HTTP, adhering to RESTful principles. The service is stateless: each request is independent.

### Endpoints
1. `/files`  
   Responds to a POST by adding to the `upload` directory the file and information sent in the request body.

2. `/files/measurements/{filename}`  
   Responds to a POST by adding a new measurement to the current file specified by the path parameter, with values passed in the request body.

3. `/files/data/{filename}`  
   Responds to a GET providing the current file specified by the path parameter.

4. `/files/list`  
   Responds to a GET providing the file that contains the list of uploaded files.

5. `/files/{filename}`  
   Responds to a DELETE removing the file with the name passed as a path parameter.

6. `/files/{date}/{time}/{filename}`  
   Responds to a DELETE removing the measurement corresponding inside the file indicated by `filename`, which contains a measurement with date and time matching those specified.

7. `/files/{date}/{time}/{filename}`  
   Responds to a PUT modifying a measurement inside the file indicated by `filename` with matching date and time, updating it with the new values passed in the request body.

### Request format

#### File upload
- Method: POST  
- URL: `/files`  
- Content-Type: `multipart/form-data`  
- Request structure (curl example):
```bash
curl --location 'http://localhost:3000/files'   --form 'citta="Urbino"'   --form 'ente="Arpa"'   --form 'file=@"/Users/macos/Desktop/L-31/TWEB/airscope/public/assets/dacaricare.csv"'
```
- Response: `201 Created` `text/plain`  
  `File uploaded and converted correctly!`

The file upload is done via POST using multer middleware; response is sent as text to be reused as feedback to the user with Bootstrap toasts.

#### Add measurement to existing file
- Method: POST  
- URL: `/files/measurements/{filename}`  
- Content-Type: `application/json`  
- Request structure:
```json
{
  "data": "2025-05-12",
  "ora": "12:00",
  "co": 0.45,
  "no2": 18.3,
  "nox": 25.7,
  "o3": 30.1,
  "pm10": 15.4
}
```
- Response: `200 OK` `text/plain`  
  `Measurement added successfully!`

#### Get specific file
- Method: GET  
- URL: `/files/data/{filename}`  
- Response: `200 OK` `application/json`  
Example response body:
```json
{
  "citta": "Urbino",
  "ente": "Arpa",
  "filename": "dacaricare.json",
  "dati": [
    {
      "data": "2025-05-12",
      "ora": "01:00",
      "co": "0.5",
      "no2": "13",
      "nox": "20",
      "o3": "74",
      "pm10": "8"
    },
    ...
  ]
}
```

#### Get list of files
- Method: GET  
- URL: `/files/list`  
- Response: `200 OK` `application/json`  
Example response:
```json
[
  {
    "filename": "dati_maggio.json",
    "path": "upload/dati_maggio.json",
    "citta": "Urbino",
    "ente": "Arpa"
  },
  {
    "filename": "dati_giugno.json",
    "path": "upload/dati_giugno.json",
    "citta": "Urbino",
    "ente": "Arpa"
  },
  ...
]
```

#### Delete file
- Method: DELETE  
- URL: `/files/{filename}`  
- Response: `200 OK` `text/plain`  
`File deleted successfully!`

#### Delete specific measurement
- Method: DELETE  
- URL: `/files/{date}/{time}/{filename}`  
- Response: `200 OK` `text/plain`  
`Measurement deleted successfully`

#### Modify specific measurement
- Method: PUT  
- URL: `/files/{date}/{time}/{filename}`  
- Content-Type: `application/json`  
- Request structure:
```json
{
  "co": "0.7",
  "no2": "11",
  "nox": "33",
  "o3": "44",
  "pm10": "55"
}
```
- Response: `200 OK` `text/plain`  
`Change applied!`

The PUT method is used to modify measurements in a specific file and the measurement to update is the one matching the date and time passed in the URL path parameters.

## Testing End-to-End
E2E testing is performed in the final phase to verify the entire application flow by simulating typical end-user interactions. The following scenarios are tested directly through the browser interface:

1. File upload
2. Add measurement to a file
3. Get file with measurements and delete measurement
4. Get list of files and delete file
5. Modify measurement
6. Change the file in use
7. Duplicate handling
8. Parsing error

## Installation (local)
1. Make sure you have Node.js (>= 14) and npm installed.
2. Clone the repository:
```bash
git clone <your-repo-url>
cd <your-repo>
```
3. Install dependencies:
```bash
npm install
```
4. Start the server:
```bash
node server.js
# or, if defined in package.json
npm start
```
5. Open your browser at `http://localhost:3000` (example port; use the one configured in the project).

## References
- Report (reference documentation): `Relazione_AirScope.pdf`
- ARPA Marche: https://www.arpa.marche.it/
- Creative Commons BY 4.0: https://creativecommons.org/licenses/by/4.0/

## Contact
Author: Samuele Caporale – samuelecaporale@icloud.com
